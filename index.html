<!DOCTYPE html>
<html>

<head>
    <title>Help Us Find Dries</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>

<body>
    <header>
        <h1>Help us find Dries</h1>
        <p>
            Dries went missing near Taghazout, Morocco, early on November 19th.<br />
            He urgently needs medical care, and time is critical.<br /><br />
            With so many people in the area, someone must have seen something.<br />
            If you or someone you know has been in the Agadir province since November 19th, please scan your Agadir
            travel
            photos for signs of Dries.<br />
        </p>
    </header>
    <div id="content">
        <div id="poster">
            <h2>Missing</h2>
            <h3>Dries De Graeve</h3>
            <img src="./dries1.jpg" />
            <p>
                29 / MALE / 1.80M" / BELGIAN (SPEAKS DUTCH)
                <br />DISTINCTIVE GAP BETWEEN TEETH
                <br />
                <b>LAST SEEN: TAGHAZOUT, MOROCCO (NOV 18 - 19)</b>
                <br /><br />
                <span class="highlight">TIPS: +32 478 697 100 (WHATSAPP)</span>
            </p>
        </div>
        <div id="instructions">
            <h2>How to help</h2>
            <h3>1. Scan your travel pictures</h3>
            <p>If you or someone you know has been in the area, Dries may appear in the background of one of your
                travel pictures. <b>This page can recognize Dries in your pictures locally, without any data
                    ever leaving your device. Your privacy is at all times respected.</b></p>
            <button onclick="document.getElementById('image-upload').click();">CHOOSE PICTURES TO SCAN</button>
            <p class="disclaimer" id="data-disclaimer">Note: loading the model may take some data bandwidth (+/- 40MB),
                WiFi connection is
                advised.
            </p>
            <input type="file" id="image-upload" multiple accept="image/*" style="display:none">
            <div id="progress-container" style="display:none">
                <p id="progress-text"></p>
                <div id="progress-bar"></div>
            </div>
            <div id="image-container"></div>
            <h3>2. Spread the word</h3>
            <p>
                We need to keep awareness around Dries' disappearance ongoing.<br /><br />
                By <a href="#" onclick="window.open('https://www.facebook.com/sharer/sharer.php?u=' + window.location)">
                    sharing this page</a> and liking the <a
                    href="https://www.facebook.com/people/Help-us-find-our-son-and-brother-Dries/61569681213585/"
                    target="_blank">Facebook page set up by his sisters</a>, you can help spead the word to
                as many people as possible.
            </p>
            <h3>3. Support financialy</h3>
            <p>This GoFundMe campaign helps cover some of the costs to keep the operation locally running. Every
                contribution is appreciated.</p>
            <div class="gfm-embed"
                data-url="https://www.gofundme.com/f/help-us-find-our-son-and-brother-dries-de-graeve/widget/medium?sharesheet=fundraiser sidebar&attribution_id=undefined">
            </div>
            <script defer src="https://www.gofundme.com/static/js/embed.js"></script>
        </div>
    </div>
    <script>
        const progressText = document.getElementById('progress-text');
        const progressBar = document.getElementById('progress-bar');
        const uploadInput = document.getElementById('image-upload');
        const scanButton = document.getElementById('scan-btn');
        const imageContainer = document.getElementById('image-container');

        const referenceImageURLs = ['./dries1.jpg', './dries2.jpg', './dries3.jpg'];
        const labeledDescriptors = [];
        let uploadedImages = [];

        function loadFaceApiScript() {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = './face-api.js';
                script.async = true; // or `defer` if you prefer
                script.onload = resolve; // Resolve the promise once the script is loaded
                script.onerror = reject; // Reject the promise on error
                document.head.appendChild(script);
            });
        }

        uploadInput.addEventListener('change', (event) => {
            uploadedImages = Array.from(event.target.files);
            imageContainer.innerHTML = '';
            document.getElementById("progress-container").style.display = "block";
            document.getElementById("data-disclaimer").style.display = "none";
            progressBar.style.width = '0%';
            progressText.innerText = 'Status: Loading face models...';
            loadFaceApiScript()
                .then(() => {
                    // Ensure face-api.js is available
                    return Promise.all([
                        faceapi.nets.tinyFaceDetector.loadFromUri('https://justadudewhohacks.github.io/face-api.js/models'),
                        faceapi.nets.faceLandmark68Net.loadFromUri('https://justadudewhohacks.github.io/face-api.js/models'),
                        faceapi.nets.faceRecognitionNet.loadFromUri('https://justadudewhohacks.github.io/face-api.js/models'),
                    ]);
                })
                .then(() => {
                    progressText.innerText = 'Status: Loading reference images...';
                    return loadReferenceImages();
                })
                .then(() => {
                    progressText.innerText = 'Status: Starting scan...';
                    return initScan();
                })
                .catch((err) => {
                    progressText.innerText = `Error: ${err.message}`;
                    console.error('Error loading face-api.js or models:', err);
                });
        });

        async function loadReferenceImages() {
            progressText.innerText = 'Status: Loading reference images...';
            for (const [index, url] of referenceImageURLs.entries()) {
                try {
                    const label = `Dries ${index + 1}`; // Unique label for each reference image
                    const image = await loadImageFromURL(url);
                    const descriptor = await getFaceDescriptor(image);
                    if (descriptor) {
                        labeledDescriptors.push(new faceapi.LabeledFaceDescriptors(label, [descriptor]));
                    } else {
                        console.warn(`No face detected in reference image: ${url}`);
                    }
                } catch (error) {
                    console.error(`Error processing reference image ${url}:`, error);
                }
            }
            if (!labeledDescriptors.length) {
                throw new Error('No valid reference images were processed.');
            }
            progressText.innerText = 'Status: Reference images loaded. Ready to scan.';
        }

        async function getFaceDescriptor(image) {
            const detection = await faceapi
                .detectSingleFace(image, new faceapi.TinyFaceDetectorOptions())
                .withFaceLandmarks()
                .withFaceDescriptor();
            return detection ? detection.descriptor : null;
        }


        async function loadImageFromURL(url) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.src = url;
                img.onload = () => resolve(img);
                img.onerror = () => reject(new Error(`Failed to load image at ${url}`));
            });
        }

        async function getFaceDescriptor(image) {
            const detection = await faceapi.detectSingleFace(image, new faceapi.TinyFaceDetectorOptions())
                .withFaceLandmarks()
                .withFaceDescriptor();
            return detection ? detection.descriptor : null;
        }

        async function initScan() {
            if (!uploadedImages.length) {
                progressText.innerText = 'Error: no images found.';
                return;
            }

            if (!labeledDescriptors.length) {
                progressText.innerText = 'Error: No reference images loaded.';
                return;
            }

            const faceMatcher = new faceapi.FaceMatcher(labeledDescriptors, 0.6);
            let completed = 0;
            const matches = [];

            for (const imageFile of uploadedImages) {
                progressText.innerText = `Status: Scanning photo ${completed + 1} of ${uploadedImages.length}...`;

                const image = await loadImageFromFile(imageFile);
                await scanImage(image, matches, faceMatcher);

                completed++;
                progressBar.style.width = `${(completed / uploadedImages.length) * 100}%`;
            }

            progressText.innerText = matches.length
                ? `Status: Scanning complete. ${matches.length} potential matches found, please review them manually and contact +32 478 697 100 on WhatsApp if you think you have found a match.`
                : `Status: Scanning complete. No matches found.`;
        }


        async function loadImageFromFile(file) {
            return new Promise((resolve) => {
                const img = document.createElement('img');
                img.src = URL.createObjectURL(file);
                img.onload = () => resolve(img);
                img.onerror = () => alert('Error loading image!');
            });
        }

        async function scanImage(image, matches, faceMatcher) {
            const wrapper = document.createElement('div');
            wrapper.className = 'image-wrapper';

            const canvas = document.createElement('canvas');
            canvas.width = image.width;
            canvas.height = image.height;

            const detections = await faceapi.detectAllFaces(image, new faceapi.TinyFaceDetectorOptions())
                .withFaceLandmarks()
                .withFaceDescriptors();

            const ctx = canvas.getContext('2d');
            let matchFound = false;

            for (const detection of detections) {
                const bestMatch = faceMatcher.findBestMatch(detection.descriptor);
                if (bestMatch.label !== 'unknown') {
                    matches.push(bestMatch.label);
                    const box = detection.detection.box;
                    ctx.strokeStyle = 'green';
                    ctx.lineWidth = 2;
                    ctx.strokeRect(box.x, box.y, box.width, box.height);
                    ctx.font = '16px Arial';
                    ctx.fillStyle = 'green';
                    console.log(bestMatch.toString());
                    ctx.fillText(bestMatch.toString(), box.x, box.y - 10);
                    matchFound = true;
                }
            }

            if (matchFound) {
                wrapper.appendChild(image);
                wrapper.appendChild(canvas);
                imageContainer.appendChild(wrapper);
            }
        }

    </script>
    <style>
        body,
        html {
            font-family: sans-serif;
        }

        .disclaimer {
            font-size: 0.8rem;
        }


        #content>div {
            flex-basis: 50%;
            flex-grow: 0;
        }

        #content {
            max-width: 1200px;
            margin: auto;
            left: 0;
            right: 0;
        }

        .highlight {
            color: #ffffff;
            background-color: red;
            font-weight: bold;
            padding: 4px;
        }

        #poster img {
            width: 60%;
            max-width: 400px;
        }


        #poster {
            text-align: center;
        }


        #poster h2 {
            color: red;
        }

        #content {
            display: flex;
        }

        .gfm-embed {
            width: 100%;
            max-width: 400px;
        }

        h1,
        h2,
        h3 {
            text-transform: uppercase;
        }

        header {
            text-align: center;
        }

        button {
            border-radius: .75rem;
            cursor: pointer;
            display: inline-flex;
            font-size: 1rem;
            font-weight: 700;
            justify-content: center;
            line-height: 1;
            padding-left: 1.5rem;
            padding-right: 1.5rem;
            text-align: center;
            border: 0;
            padding: 15px 40px;
            background: rgb(151, 210, 255);
            background: linear-gradient(0deg, rgba(151, 210, 255, 1) 0%, rgba(169, 245, 255, 1) 100%);
        }

        button:hover {
            background: rgb(151, 210, 255);
            background: linear-gradient(0deg, rgba(169, 245, 255, 1) 0%, rgba(151, 210, 255, 1) 100%);

        }

        #progress-container {
            margin: 20px 0;
        }

        #progress-text {
            margin-bottom: 10px;
            font-weight: bold;
            color: blue;
        }

        #progress-bar {
            width: 0;
            height: 20px;
            background-color: #4caf50;
            transition: width 0.3s;
        }

        .image-wrapper {
            position: relative;
            display: inline-block;
        }

        .image-wrapper img,
        .image-wrapper canvas {
            width: 100%;
        }

        canvas {
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: none;
            /* Ensure the canvas does not interfere with interactions */
        }

        @media (max-width: 700px) {
            #content {
                flex-direction: column !important;
            }

            body,
            html {
                font-size: 0.8rem;
                padding: 10px;
            }
        }
    </style>
</body>

</html>